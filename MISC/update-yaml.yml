#update-yaml
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-yaml
spec:
  params:  
  - name: yaml-path
  - name: appImage
  - name: buildRevision
  - default: ''
    description: Repository URL to clone from.
    name: url
    type: string
  - default: ''
    description: 'Revision to checkout. (branch, tag, sha, ref, etc...)'
    name: revision
    type: string
  - default: ''
    description: Refspec to fetch before checking out revision.
    name: refspec
    type: string
  - default: 'true'
    description: Initialize and fetch git submodules.
    name: submodules
    type: string
  - default: '1'
    description: 'Perform a shallow clone, fetching only the most recent N commits.'
    name: depth
    type: string
  - default: 'true'
    description: >-
      Set the `http.sslVerify` global git config. Setting this to `false` is
      not advised unless you are sure that you trust your git remote.
    name: sslVerify
    type: string
  - default: ''
    description: Subdirectory inside the `output` Workspace to clone the repo into.
    name: subdirectory
    type: string
  - default: ''
    description: >-
      Define the directory patterns to match or exclude when performing a
      sparse checkout.
    name: sparseCheckoutDirectories
    type: string
  - default: 'true'
    description: >-
      Clean out the contents of the destination directory if it already exists
      before cloning.
    name: deleteExisting
    type: string
  - default: ''
    description: HTTP proxy server for non-SSL requests.
    name: httpProxy
    type: string
  - default: ''
    description: HTTPS proxy server for SSL requests.
    name: httpsProxy
    type: string
  - default: ''
    description: Opt out of proxying HTTP/HTTPS requests.
    name: noProxy
    type: string
  - default: 'true'
    description: Log the commands that are executed during `git-clone`'s operation.
    name: verbose
    type: string
  - default: >-
      registry.redhat.io/openshift-pipelines/pipelines-git-init-rhel8@sha256:158b0fda662e5bc05e2ff46f6864a8620bbb45e1a2388a456de43aad6e72d8f7
    description: The image providing the git-init binary that this Task runs.
    name: gitInitImage
    type: string
  - default: /tekton/home
    description: >
      Absolute path to the user's home directory. Set this explicitly if you
      are running the image as a non-root user or have overridden

      the gitInitImage param with an image containing custom user
      configuration.
    name: userHome
    type: string
  workspaces:
  - name: shared-workspace
  steps:
  - env:
        - name: HOME
          value: $(params.userHome)
        - name: PARAM_URL
          value: $(params.url)
        - name: PARAM_REVISION
          value: $(params.revision)
        - name: PARAM_REFSPEC
          value: $(params.refspec)
        - name: PARAM_SUBMODULES
          value: $(params.submodules)
        - name: PARAM_DEPTH
          value: $(params.depth)
        - name: PARAM_SSL_VERIFY
          value: $(params.sslVerify)
        - name: PARAM_SUBDIRECTORY
          value: $(params.subdirectory)
        - name: PARAM_DELETE_EXISTING
          value: $(params.deleteExisting)
        - name: PARAM_HTTP_PROXY
          value: $(params.httpProxy)
        - name: PARAM_HTTPS_PROXY
          value: $(params.httpsProxy)
        - name: PARAM_NO_PROXY
          value: $(params.noProxy)
        - name: PARAM_VERBOSE
          value: $(params.verbose)
        - name: PARAM_SPARSE_CHECKOUT_DIRECTORIES
          value: $(params.sparseCheckoutDirectories)
        - name: PARAM_USER_HOME
          value: $(params.userHome)
        - name: WORKSPACE_OUTPUT_PATH
          value: $(workspaces.output.path)
        - name: WORKSPACE_SSH_DIRECTORY_BOUND
          value: $(workspaces.ssh-directory.bound)
        - name: WORKSPACE_SSH_DIRECTORY_PATH
          value: $(workspaces.ssh-directory.path)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_BOUND
          value: $(workspaces.basic-auth.bound)
        - name: WORKSPACE_BASIC_AUTH_DIRECTORY_PATH
          value: $(workspaces.basic-auth.path)
    name: update-deploymwnt-image
    image: registry.redhat.io/openshift-pipelines/pipelines-git-init-rhel8@sha256:158b0fda662e5bc05e2ff46f6864a8620bbb45e1a2388a456de43aad6e72d8f7
    workingDir: "$(workspaces.source.path)/$(params.yaml-path)"
    script: |
      #!/usr/bin/env sh
      set -eu
      
      echo "updating $(inputs.params.yaml-path) image to $(inputs.params.appImage):$(inputs.params.buildRevision)"
      sed -i "s#$(inputs.params.appImage):[a-zA-Z0-9]\\+#$(inputs.params.appImage):$(inputs.params.buildRevision)#" deployment.yaml
